#!/usr/bin/env bash
set -e
IFS=$'\n\t'

FFMPEG="/usr/bin/ffmpeg"
ZENITY="/usr/bin/zenity"
NOTIFY="/usr/bin/notify-send"

# Embedded functions to avoid dependency issues
is_valid_file() {
    local input_file="$1"
    local min_size=1024  # 1KB minimum size

    # Check file exists and is readable
    if [[ ! -f "$input_file" || ! -r "$input_file" ]]; then
        return 1
    fi

    # Check file size is reasonable
    local file_size=$(stat -c%s "$input_file" 2>/dev/null || echo 0)
    if [[ $file_size -lt $min_size ]]; then
        return 1
    fi

    # Check if ffprobe can read the file
    if ! ffprobe -v error -show_format "$input_file" >/dev/null 2>&1; then
        return 1
    fi

    return 0
}

detect_audio_streams() {
    local input_file="$1"
    local audio_streams
    audio_streams=$(ffprobe -v error -select_streams a -show_entries stream=codec_name -of csv=p=0 "$input_file" 2>/dev/null)
    if [[ -z "$audio_streams" ]]; then
        echo "none"
    else
        echo "$audio_streams"
    fi
}

has_aac_audio() {
    local input_file="$1"
    local audio_streams
    audio_streams=$(detect_audio_streams "$input_file")
    if [[ "$audio_streams" == "none" ]]; then
        return 1
    fi
    if echo "$audio_streams" | grep -q "aac"; then
        return 0
    else
        return 1
    fi
}

get_unique_filename() {
    local dir="$1"
    local name="$2"
    local ext="$3"
    local counter=1
    if [[ ! -f "$dir/$name.$ext" ]]; then
        echo "$name.$ext"
        return 0
    fi
    while [[ -f "$dir/$name ($counter).$ext" ]]; do
        ((counter++))
    done
    echo "$name ($counter).$ext"
}

# Convert AAC audio streams to FLAC (16-bit, 48k) and create a new .mkv file
for INPUT in "$@"; do
  [[ -f "$INPUT" ]] || continue

  DIR="$(dirname "$INPUT")"
  BASENAME="$(basename "$INPUT")"
  NAME="${BASENAME%.*}"

  # Check if file is valid and not corrupted
  if ! is_valid_file "$INPUT"; then
    $NOTIFY "AAC→FLAC" "Skipped: $BASENAME (file is corrupted or unreadable)"
    continue
  fi

  # Check if file has AAC audio streams
  if ! has_aac_audio "$INPUT"; then
    audio_streams=$(detect_audio_streams "$INPUT")
    if [[ "$audio_streams" == "none" ]]; then
      $NOTIFY "AAC→FLAC" "Skipped: $BASENAME (no audio streams found)"
    else
      $NOTIFY "AAC→FLAC" "Skipped: $BASENAME (no AAC audio streams found)"
    fi
    continue
  fi

  # Get unique filename to avoid overwriting
  output_filename=$(get_unique_filename "$DIR" "$NAME" "mkv")
  TMP_OUTPUT="$(mktemp --tmpdir="$DIR" ".${NAME}.XXXXXX.mkv")"

  # get duration (HH:MM:SS.ms)
  DURATION=$($FFMPEG -i "$INPUT" 2>&1 | grep "Duration" | awk '{print $2}' | tr -d , || echo "00:00:00.00")
  HOURS=${DURATION:0:2}
  MINUTES=${DURATION:3:2}
  SECONDS=${DURATION:6:5}
  TOTAL_SEC=$(echo "$HOURS*3600 + $MINUTES*60 + $SECONDS" | bc)

  (
    echo "Converting to FLAC..."
    $FFMPEG -y -i "$INPUT" \
      -map 0:v:0 \
      -map 0:a:0 \
      -map 0:s? \
      -c:v copy \
      -c:a flac -sample_fmt s16 -ar 48000 \
      -c:s copy \
      -map_metadata 0 \
      "$TMP_OUTPUT" -progress pipe:1 2>/dev/null | \
    while read -r line; do
      if [[ "$line" =~ out_time_ms=([0-9]+) ]]; then
        OUT_MS=${BASH_REMATCH[1]}
        OUT_SEC=$(echo "$OUT_MS / 1000000" | bc)
        if [[ "$TOTAL_SEC" -gt 0 ]]; then
          PCT=$(echo "$OUT_SEC * 100 / $TOTAL_SEC" | bc)
          if [[ "$PCT" -lt 0 ]]; then PCT=0; fi
          if [[ "$PCT" -gt 100 ]]; then PCT=100; fi
        else
          PCT=0
        fi
        echo $PCT
        echo "# Converting $BASENAME to FLAC — $(date -u -d @$OUT_SEC +%T) elapsed"
      fi
    done
  ) | $ZENITY --progress --title="AAC → FLAC (.mkv)" --percentage=0 --auto-close --width=420

  FFmpeg_exit_code=${PIPESTATUS[0]}

  if [[ $FFmpeg_exit_code -ne 0 ]]; then
    $NOTIFY "AAC→FLAC" "Conversion failed: $BASENAME (FFmpeg error $FFmpeg_exit_code)"
    rm -f "$TMP_OUTPUT"
    continue
  fi

  if [[ -f "$TMP_OUTPUT" ]]; then
    FINAL="$DIR/$output_filename"
    mv "$TMP_OUTPUT" "$FINAL"

    # Check if filename was modified
    if [[ "$output_filename" != "${NAME}.mkv" ]]; then
      $NOTIFY "AAC→FLAC" "Created: $output_filename (renamed to avoid overwrite)"
    else
      $NOTIFY "AAC→FLAC" "Created: $output_filename"
    fi
  else
    $NOTIFY "AAC→FLAC" "Conversion failed: $BASENAME"
  fi
done